# Backend Architecture - Visual Guide

## ğŸ›ï¸ Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HTTP REQUEST                             â”‚
â”‚                              â†“                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ROUTES LAYER (app/routes/activities_new.py)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  @router.post("/")                                         â”‚  â”‚
â”‚  â”‚  async def create_activity(...)                            â”‚  â”‚
â”‚  â”‚      controller = ActivityController(db)                   â”‚  â”‚
â”‚  â”‚      return await controller.create_activity(...)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Responsibility: API endpoint definitions ONLY                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER LAYER (app/controllers/activity_controller.py)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  async def create_activity(self, data, user):              â”‚  â”‚
â”‚  â”‚      # Check permissions                                   â”‚  â”‚
â”‚  â”‚      if not self._check_create_permission(user):           â”‚  â”‚
â”‚  â”‚          raise HTTPException(403)                          â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚      # Delegate to service                                 â”‚  â”‚
â”‚  â”‚      return self.service.create_activity(data, user)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Responsibility: HTTP handling, permissions, error formatting   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE LAYER (app/services/activity_service.py)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  def create_activity(self, data, user):                    â”‚  â”‚
â”‚  â”‚      # Business logic                                      â”‚  â”‚
â”‚  â”‚      activity_dict = data.dict(exclude={'custom_fields'})  â”‚  â”‚
â”‚  â”‚      activity_dict['user_id'] = user.id                    â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚      # Use repository for data access                      â”‚  â”‚
â”‚  â”‚      db_activity = self.repository.create(...)             â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚      # Orchestrate with other services                     â”‚  â”‚
â”‚  â”‚      CustomFieldService.save_custom_field_values(...)      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚      # Manage transaction                                  â”‚  â”‚
â”‚  â”‚      self.db.commit()                                      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚      return self._build_activity_response(db_activity)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Responsibility: Business logic, orchestration, transactions    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REPOSITORY LAYER (app/repositories/activity_repository.py)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  def create(self, obj_in: Dict) -> Activity:               â”‚  â”‚
â”‚  â”‚      db_obj = Activity(**obj_in)                           â”‚  â”‚
â”‚  â”‚      self.db.add(db_obj)                                   â”‚  â”‚
â”‚  â”‚      self.db.flush()                                       â”‚  â”‚
â”‚  â”‚      self.db.refresh(db_obj)                               â”‚  â”‚
â”‚  â”‚      return db_obj                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Responsibility: Database queries and data access ONLY          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE                                 â”‚
â”‚                    (PostgreSQL)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete Request/Response Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT  â”‚
â”‚ (Browser)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ POST /api/v1/activities
     â”‚ { "type": "meeting", "subject": "Demo" }
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROUTE: activities_new.py                               â”‚
â”‚                                                         â”‚
â”‚ @router.post("/")                                      â”‚
â”‚ def create_activity(data, db, current_user):           â”‚
â”‚     controller = ActivityController(db)                â”‚
â”‚     return controller.create_activity(data, user)      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Pass (data, current_user)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONTROLLER: activity_controller.py                     â”‚
â”‚                                                         â”‚
â”‚ 1. Check if user has permission to create             â”‚
â”‚    â”œâ”€ Yes: Continue                                   â”‚
â”‚    â””â”€ No: Raise HTTPException(403)                    â”‚
â”‚                                                         â”‚
â”‚ 2. Call service.create_activity(data, user)           â”‚
â”‚                                                         â”‚
â”‚ 3. Handle exceptions and convert to HTTP errors       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Pass (data, current_user)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE: activity_service.py                           â”‚
â”‚                                                         â”‚
â”‚ 1. Extract custom_fields from data                    â”‚
â”‚                                                         â”‚
â”‚ 2. Prepare activity_dict                              â”‚
â”‚    activity_dict = {                                   â”‚
â”‚        "type": "meeting",                             â”‚
â”‚        "subject": "Demo",                             â”‚
â”‚        "user_id": current_user.id                     â”‚
â”‚    }                                                   â”‚
â”‚                                                         â”‚
â”‚ 3. Call repository.create(activity_dict)              â”‚
â”‚                                                         â”‚
â”‚ 4. Save custom fields via CustomFieldService          â”‚
â”‚                                                         â”‚
â”‚ 5. Commit transaction: self.db.commit()               â”‚
â”‚                                                         â”‚
â”‚ 6. Build response with custom fields                  â”‚
â”‚                                                         â”‚
â”‚ 7. Return ActivityResponse object                     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Pass (activity_dict)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REPOSITORY: activity_repository.py                     â”‚
â”‚                                                         â”‚
â”‚ 1. Create SQLAlchemy object                           â”‚
â”‚    db_obj = Activity(**obj_in)                        â”‚
â”‚                                                         â”‚
â”‚ 2. Add to session                                     â”‚
â”‚    self.db.add(db_obj)                                â”‚
â”‚                                                         â”‚
â”‚ 3. Flush to get ID                                    â”‚
â”‚    self.db.flush()                                    â”‚
â”‚                                                         â”‚
â”‚ 4. Refresh to load defaults                           â”‚
â”‚    self.db.refresh(db_obj)                            â”‚
â”‚                                                         â”‚
â”‚ 5. Return Activity object                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Execute SQL
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE: PostgreSQL                                   â”‚
â”‚                                                         â”‚
â”‚ INSERT INTO activities (                               â”‚
â”‚     id, type, subject, user_id, created_at, ...       â”‚
â”‚ ) VALUES (                                             â”‚
â”‚     'uuid-here', 'meeting', 'Demo', 'user-id', NOW()  â”‚
â”‚ )                                                      â”‚
â”‚                                                         â”‚
â”‚ RETURNING *                                            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Activity object with ID
     â†“
     â”‚ (Response flows back up through layers)
     â”‚
     â”‚ Repository â†’ Service â†’ Controller â†’ Route
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT  â”‚
â”‚ Receives: â”‚
â”‚ {         â”‚
â”‚   "id": "uuid",                                         â”‚
â”‚   "type": "meeting",                                    â”‚
â”‚   "subject": "Demo",                                    â”‚
â”‚   "user_id": "user-id",                                â”‚
â”‚   "created_at": "2025-10-07T...",                      â”‚
â”‚   "custom_fields": {...}                               â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© Layer Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ROUTES                           â”‚
â”‚                       â†“                             â”‚
â”‚                  depends on                         â”‚
â”‚                       â†“                             â”‚
â”‚                  CONTROLLERS                        â”‚
â”‚                       â†“                             â”‚
â”‚                  depends on                         â”‚
â”‚                       â†“                             â”‚
â”‚                   SERVICES                          â”‚
â”‚                       â†“                             â”‚
â”‚                  depends on                         â”‚
â”‚                       â†“                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚    â”‚                                 â”‚              â”‚
â”‚    â†“                                 â†“              â”‚
â”‚ REPOSITORIES                  OTHER SERVICES        â”‚
â”‚    â†“                                 â†“              â”‚
â”‚  MODELS                           MODELS            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All layers depend on:
- SCHEMAS (for type definitions)
- CORE (for database, auth, config)
```

---

## ğŸ“¦ File Structure with Annotations

```
app/
â”‚
â”œâ”€â”€ models/                    # ğŸ—„ï¸ DATABASE LAYER
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ activity.py           # SQLAlchemy model
â”‚   â”‚   â”œâ”€â”€ Table structure
â”‚   â”‚   â”œâ”€â”€ Columns
â”‚   â”‚   â”œâ”€â”€ Relationships
â”‚   â”‚   â””â”€â”€ Constraints
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ schemas/                   # âœ… VALIDATION LAYER
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ activity.py           # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ ActivityCreate    # Request body
â”‚   â”‚   â”œâ”€â”€ ActivityUpdate    # Update request
â”‚   â”‚   â”œâ”€â”€ ActivityResponse  # API response
â”‚   â”‚   â””â”€â”€ ActivityWithRelations
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ repositories/              # ğŸ’¾ DATA ACCESS LAYER
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_repository.py    # Reusable CRUD
â”‚   â”‚   â”œâ”€â”€ create()
â”‚   â”‚   â”œâ”€â”€ get()
â”‚   â”‚   â”œâ”€â”€ get_multi()
â”‚   â”‚   â”œâ”€â”€ update()
â”‚   â”‚   â”œâ”€â”€ delete()
â”‚   â”‚   â””â”€â”€ exists()
â”‚   â”‚
â”‚   â”œâ”€â”€ activity_repository.py # Activity-specific queries
â”‚   â”‚   â”œâ”€â”€ get_with_relations()
â”‚   â”‚   â”œâ”€â”€ get_by_user()
â”‚   â”‚   â”œâ”€â”€ get_by_contact()
â”‚   â”‚   â”œâ”€â”€ get_by_deal()
â”‚   â”‚   â””â”€â”€ get_recent_activities()
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/                  # ğŸ§  BUSINESS LOGIC LAYER
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ activity_service.py   # Activity business logic
â”‚   â”‚   â”œâ”€â”€ get_activity_by_id()
â”‚   â”‚   â”œâ”€â”€ get_activities()
â”‚   â”‚   â”œâ”€â”€ create_activity()
â”‚   â”‚   â”‚   â”œâ”€â”€ Extract custom fields
â”‚   â”‚   â”‚   â”œâ”€â”€ Call repository
â”‚   â”‚   â”‚   â”œâ”€â”€ Orchestrate services
â”‚   â”‚   â”‚   â”œâ”€â”€ Manage transaction
â”‚   â”‚   â”‚   â””â”€â”€ Build response
â”‚   â”‚   â”œâ”€â”€ update_activity()
â”‚   â”‚   â”œâ”€â”€ delete_activity()
â”‚   â”‚   â””â”€â”€ _build_activity_response()
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ controllers/               # ğŸ® HTTP LAYER
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ activity_controller.py # HTTP request handler
â”‚   â”‚   â”œâ”€â”€ get_activities()
â”‚   â”‚   â”‚   â”œâ”€â”€ Apply permission filters
â”‚   â”‚   â”‚   â””â”€â”€ Call service
â”‚   â”‚   â”œâ”€â”€ get_activity()
â”‚   â”‚   â”œâ”€â”€ create_activity()
â”‚   â”‚   â”‚   â”œâ”€â”€ Check permissions
â”‚   â”‚   â”‚   â”œâ”€â”€ Call service
â”‚   â”‚   â”‚   â””â”€â”€ Handle exceptions â†’ HTTP errors
â”‚   â”‚   â”œâ”€â”€ update_activity()
â”‚   â”‚   â”œâ”€â”€ delete_activity()
â”‚   â”‚   â””â”€â”€ _check_create_permission()
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ routes/                    # ğŸ›£ï¸ API ENDPOINTS
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ activities_new.py     # Clean route definitions
â”‚   â”‚   â”œâ”€â”€ GET /
â”‚   â”‚   â”œâ”€â”€ GET /{id}
â”‚   â”‚   â”œâ”€â”€ POST /
â”‚   â”‚   â”œâ”€â”€ PUT /{id}
â”‚   â”‚   â””â”€â”€ DELETE /{id}
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ core/                      # âš™ï¸ CORE UTILITIES
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ database.py           # DB connection
â”‚   â”œâ”€â”€ auth.py               # Authentication
â”‚   â”œâ”€â”€ auth_helpers.py       # Permission helpers
â”‚   â”œâ”€â”€ config.py             # Configuration
â”‚   â””â”€â”€ security.py           # Security utils
â”‚
â””â”€â”€ middleware/                # ğŸ”§ CROSS-CUTTING
    â”œâ”€â”€ __init__.py
    â””â”€â”€ (future middleware)
```

---

## ğŸ¯ Responsibility Matrix

| What | Route | Controller | Service | Repository |
|------|-------|------------|---------|------------|
| Define API endpoint | âœ… | âŒ | âŒ | âŒ |
| Check permissions | âŒ | âœ… | âŒ | âŒ |
| Validate input | âœ… (schema) | âŒ | âŒ | âŒ |
| Business logic | âŒ | âŒ | âœ… | âŒ |
| Orchestrate services | âŒ | âŒ | âœ… | âŒ |
| Database queries | âŒ | âŒ | âŒ | âœ… |
| Manage transactions | âŒ | âŒ | âœ… | âŒ |
| Format HTTP response | âœ… (schema) | âœ… | âŒ | âŒ |
| Handle HTTP errors | âŒ | âœ… | âŒ | âŒ |
| Reusable across features | âŒ | âŒ | âœ… | âœ… |

---

## ğŸ” Permission Flow

```
User makes request
    â†“
Route (with Depends(get_current_user))
    â†“
Controller receives current_user
    â†“
Controller checks permissions
    â”œâ”€ has_any_permission()
    â”œâ”€ check_activity_edit_permission()
    â””â”€ check_activity_delete_permission()
    â†“
IF authorized: Call service
IF not: Raise HTTPException(403)
```

---

## ğŸ’¡ Key Design Principles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SINGLE RESPONSIBILITY PRINCIPLE         â”‚
â”‚  Each layer does ONE thing well          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEPENDENCY INVERSION                    â”‚
â”‚  Depend on abstractions (BaseRepository) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SEPARATION OF CONCERNS                  â”‚
â”‚  HTTP â‰  Business Logic â‰  Data Access    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DRY (Don't Repeat Yourself)            â”‚
â”‚  Reusable repositories and services      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Benefits Visualized

### Before (Monolithic Route)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   routes/activities.py (271 lines)  â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â€¢ API definition            â”‚  â”‚
â”‚   â”‚ â€¢ Permission checks         â”‚  â”‚
â”‚   â”‚ â€¢ Business logic            â”‚  â”‚
â”‚   â”‚ â€¢ Database queries          â”‚  â”‚
â”‚   â”‚ â€¢ Transaction management    â”‚  â”‚
â”‚   â”‚ â€¢ Error handling            â”‚  â”‚
â”‚   â”‚ â€¢ Response building         â”‚  â”‚
â”‚   â”‚ â€¢ Custom field logic        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚   âš ï¸ Everything tangled together    â”‚
â”‚   âš ï¸ Hard to test                   â”‚
â”‚   âš ï¸ Hard to maintain               â”‚
â”‚   âš ï¸ Can't reuse                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After (Layered Architecture)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route (120 L)   â”‚  â”‚ Controller (230L)â”‚  â”‚  Service (330L)  â”‚  â”‚ Repository (230L)â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚  â€¢ API endpoint  â”‚â†’ â”‚ â€¢ Permissions    â”‚â†’ â”‚ â€¢ Business logic â”‚â†’ â”‚ â€¢ DB queries    â”‚
â”‚                  â”‚  â”‚ â€¢ HTTP handling  â”‚  â”‚ â€¢ Orchestration  â”‚  â”‚ â€¢ Data access   â”‚
â”‚                  â”‚  â”‚ â€¢ Error format   â”‚  â”‚ â€¢ Transactions   â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Single responsibility     âœ… Testable     âœ… Maintainable     âœ… Reusable
```

---

**Use these diagrams to understand the architecture at a glance! ğŸ“Š**
