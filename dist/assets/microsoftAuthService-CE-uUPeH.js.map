{"version":3,"file":"microsoftAuthService-CE-uUPeH.js","sources":["../../src/services/microsoftAuthService.js"],"sourcesContent":["/**\n * Microsoft Authentication Service\n *\n * Handles Microsoft SSO authentication flows:\n * 1. Popup OAuth flow for \"Sign in with Microsoft\" button\n * 2. Silent SSO for SharePoint integration\n */\n\nconst API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000/';\n\nclass MicrosoftAuthService {\n  constructor() {\n    this.popup = null;\n    this.popupCheckInterval = null;\n  }\n\n  /**\n   * Initiate Microsoft login with popup window\n   * @returns {Promise<{token: string, user: object}>} Authentication result\n   */\n  async initiateMicrosoftLogin() {\n    try {\n      // Get authorization URL from backend\n      const response = await fetch(`${API_BASE_URL}api/v1/auth/microsoft/login`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.detail || 'Failed to initiate Microsoft login');\n      }\n\n      const { auth_url, state } = await response.json();\n\n      // Open Microsoft login in popup\n      return await this.openLoginPopup(auth_url, state);\n    } catch (error) {\n      console.error('❌ Microsoft login initiation failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Open Microsoft login popup and monitor for callback\n   * @param {string} authUrl - Microsoft authorization URL\n   * @param {string} state - CSRF state token\n   * @returns {Promise<{token: string, user: object}>}\n   */\n  async openLoginPopup(authUrl, state) {\n    return new Promise((resolve, reject) => {\n      // Calculate popup position (centered on screen)\n      const width = 600;\n      const height = 700;\n      const left = window.screen.width / 2 - width / 2;\n      const top = window.screen.height / 2 - height / 2;\n\n      // Open popup\n      this.popup = window.open(\n        authUrl,\n        'Microsoft Login',\n        `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,location=no,status=no`\n      );\n\n      if (!this.popup) {\n        reject(new Error('Popup blocked. Please allow popups for this site and try again.'));\n        return;\n      }\n\n      // Monitor popup for completion\n      this.popupCheckInterval = setInterval(() => {\n        try {\n          // Check if popup was closed by user\n          if (!this.popup || this.popup.closed) {\n            clearInterval(this.popupCheckInterval);\n            reject(new Error('Login cancelled by user'));\n            return;\n          }\n\n          // Try to read popup URL (will throw if different origin)\n          const popupUrl = this.popup.location.href;\n\n          // Check if we've been redirected to our callback page\n          if (popupUrl.includes('/auth/microsoft/success')) {\n            clearInterval(this.popupCheckInterval);\n\n            // Extract token and user from URL\n            const url = new URL(popupUrl);\n            const token = url.searchParams.get('token');\n            const userJson = url.searchParams.get('user');\n\n            if (token && userJson) {\n              const user = JSON.parse(decodeURIComponent(userJson));\n\n              // Close popup\n              this.popup.close();\n              this.popup = null;\n\n              resolve({ token, user });\n            } else {\n              this.popup.close();\n              this.popup = null;\n              reject(new Error('Invalid callback parameters'));\n            }\n          }\n\n          // Check for error\n          if (popupUrl.includes('/login?error=')) {\n            clearInterval(this.popupCheckInterval);\n            const url = new URL(popupUrl);\n            const error = url.searchParams.get('error');\n\n            this.popup.close();\n            this.popup = null;\n            reject(new Error(decodeURIComponent(error)));\n          }\n        } catch (e) {\n          // Cross-origin error is expected while popup is on Microsoft domain\n          // We'll keep checking until it redirects back to our domain\n        }\n      }, 500); // Check every 500ms\n    });\n  }\n\n  /**\n   * Attempt silent SSO login for SharePoint integration\n   * @param {string} microsoftAccessToken - Microsoft access token from SharePoint context\n   * @param {object} userInfo - User information from Microsoft\n   * @returns {Promise<{token: string, user: object}>}\n   */\n  async silentSSOLogin(microsoftAccessToken, userInfo) {\n    try {\n      const response = await fetch(`${API_BASE_URL}api/v1/auth/microsoft/silent`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          access_token: microsoftAccessToken,\n          email: userInfo.email,\n          microsoft_id: userInfo.microsoft_id,\n          first_name: userInfo.first_name,\n          last_name: userInfo.last_name,\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.detail || 'Silent SSO failed');\n      }\n\n      const data = await response.json();\n      return {\n        token: data.access_token,\n        user: data.user,\n      };\n    } catch (error) {\n      console.error('❌ Silent SSO failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Check if SharePoint SSO should be attempted\n   * @returns {boolean}\n   */\n  shouldAttemptSharePointSSO() {\n    // Check URL parameter\n    const urlParams = new URLSearchParams(window.location.search);\n    const ssoParam = urlParams.get('sso');\n\n    return ssoParam === 'auto';\n  }\n\n  /**\n   * Cancel ongoing authentication\n   */\n  cancel() {\n    if (this.popupCheckInterval) {\n      clearInterval(this.popupCheckInterval);\n      this.popupCheckInterval = null;\n    }\n\n    if (this.popup && !this.popup.closed) {\n      this.popup.close();\n      this.popup = null;\n    }\n  }\n}\n\n// Export singleton instance\nexport const microsoftAuthService = new MicrosoftAuthService();\nexport default microsoftAuthService;\n"],"names":["API_BASE_URL","MicrosoftAuthService","response","error","auth_url","state","authUrl","resolve","reject","left","top","popupUrl","url","token","userJson","user","microsoftAccessToken","userInfo","data","microsoftAuthService"],"mappings":"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"}